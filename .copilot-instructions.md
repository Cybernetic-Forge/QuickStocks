# QuickStocks - Copilot Instructions

## 📋 Table of Contents
- [Quick Start](#quick-start) - Essential info for getting started
- [Development Environment Setup](#development-environment-setup) - Build and dev setup
- [Development Guidelines](#development-guidelines) - Coding patterns and standards
- [Core Features Implemented](#core-features-implemented) - Current functionality
- [Testing Strategy](#-testing-strategy) - How to test changes
- [Troubleshooting Guide](#-troubleshooting-guide) - Common issues and solutions
- [Architecture Decisions](#architecture-decisions) - Why things are built this way

## Quick Start
QuickStocks is a Minecraft Paper plugin (version 1.21.8) that simulates a realistic stock market within the game.

**TL;DR for Copilot:**
- 🏗️ **Architecture**: IoC pattern with clean layer separation (core/application/infrastructure)
- 🗄️ **Database**: Multi-provider support (SQLite/MySQL/PostgreSQL) with automatic migrations
- 🎮 **Minecraft**: Paper plugin with `/stocks` and `/crypto` commands
- ⚠️ **Build Issues**: Use `pom-test.xml` for local development due to PaperMC repo connectivity
- 🧪 **Testing**: Run `StockMarketSimulationTest` to verify market behavior

## Project Overview
QuickStocks provides players with an immersive stock trading experience based on real-world market factors and behaviors. The plugin features realistic price calculations, comprehensive market simulation, and full database persistence.

## Architecture
The project follows an **Inversion of Control (IoC) architecture** with clear separation of concerns:

```
src/main/java/com/example/quickstocks/
├── QuickStocksPlugin.java          # Main plugin class
├── application/                    # Application layer
│   └── boot/                      # Bootstrap and seeding
│       ├── ItemSeeder.java        # Seeds Minecraft items as instruments
│       ├── MockMaterial.java      # Mock materials for testing
│       └── WordUtils.java         # String utilities
├── core/
│   ├── services/                   # Business logic services
│   │   └── StockMarketService.java # Core market management
│   ├── models/                     # Data models
│   │   ├── Stock.java             # Stock representation
│   │   └── MarketInfluence.java   # Market factor influences
│   ├── algorithms/                # Core algorithms
│   │   └── StockPriceCalculator.java # Realistic price calculation
│   ├── enums/                     # Enumerations
│   │   └── MarketFactor.java      # Market influence factors
│   ├── interfaces/                # Contracts (future)
│   └── events/                    # Event system (future)
└── infrastructure/                # Infrastructure layer
    └── db/                        # Database layer
        ├── ConfigLoader.java      # Configuration file loader
        ├── DatabaseConfig.java    # Database configuration holder
        ├── DatabaseManager.java   # Central DB coordinator
        ├── DataSourceProvider.java # Connection pooling
        ├── Db.java               # Database utility wrapper
        └── MigrationRunner.java   # Schema migration management
```

## Development Environment Setup

### Prerequisites
- **Java 17+** (verified with OpenJDK 17)
- **Maven 3.9+** for build management
- **IDE**: IntelliJ IDEA recommended (.idea folder configured)

### Build Commands
```bash
# ⚠️ Use test profile due to PaperMC connectivity issues
mvn -f pom-test.xml clean compile
mvn -f pom-test.xml test

# For production builds (when PaperMC is accessible)
mvn clean package
```

### Common Issues & Solutions
- **PaperMC repo unreachable**: Use `pom-test.xml` instead of `pom.xml`
- **Plugin not loading**: Ensure `.ready` files are renamed to `.java` (use `activate-plugin.sh`)
- **Database errors**: Check SQLite file permissions or MySQL/PostgreSQL connectivity
- **Test failures**: Run database migrations first with `SimpleMigrationTest`

### 📂 Key Files & Locations
**Configuration:**
- `src/main/resources/config.yml` - Main plugin configuration
- `src/main/resources/plugin.yml` - Minecraft plugin descriptor
- `src/main/resources/migrations/` - Database schema migrations

**Core Services:**
- `src/main/java/com/example/quickstocks/core/services/StockMarketService.java` - Main market logic
- `src/main/java/com/example/quickstocks/infrastructure/db/DatabaseManager.java` - Database coordinator
- `src/main/java/com/example/quickstocks/core/algorithms/StockPriceCalculator.java` - Price calculation

**Plugin Entry Points:**
- `src/main/java/com/example/quickstocks/QuickStocksPlugin.java.ready` - Main plugin class (rename to .java)
- `src/main/java/com/example/quickstocks/commands/` - Command handlers (.ready files)

**Build Files:**
- `pom.xml` - Main Maven config (PaperMC dependency issues)
- `pom-test.xml` - Alternative build config for development
- `activate-plugin.sh` - Script to activate plugin files

## Core Features Implemented

### 1. Database Layer & Persistence System
- **Location**: `infrastructure.db` package
- **Components**:
  - **DatabaseManager**: Central coordinator for DB initialization, migrations, and connection management
  - **ConfigLoader**: Loads database configuration from `config.yml` or properties files
  - **DatabaseConfig**: Configuration holder supporting SQLite, MySQL, and PostgreSQL
  - **DataSourceProvider**: Connection pooling and database provider abstraction
  - **Db**: Database utility wrapper with simplified query/update operations
  - **MigrationRunner**: Schema migration management with versioning support
- **Migration System**: 
  - **Location**: `src/main/resources/migrations/`
  - **Current Version**: V1 (V1__init.sql)
  - **Features**: Automatic schema versioning, rollback tracking, migration status logging

### 2. Database Schema (v1)
- **instruments** table: Core instrument registry
  - Supports multiple types: ITEM, CRYPTO, EQUITY, INDEX, FUND, CUSTOM_CRYPTO
  - Generic schema for Minecraft items, cryptocurrencies, and traditional stocks
  - Fields: id (UUID), type, symbol, display_name, mc_material, decimals, created_by, created_at
- **instrument_state** table: Current market state for fast reads
  - Real-time price and volume data
  - Performance metrics: change_1h, change_24h, volatility_24h, market_cap
  - Updated via market simulation engine
- **instrument_price_history** table: Append-only historical data
  - Complete price/volume history for analytics
  - Tracks reasons for price movements (market factors)
  - Indexed by instrument and timestamp for efficient queries

### 3. Configuration System
- **Location**: `src/main/resources/config.yml`
- **Database Configuration Keys**:
  - `database.provider`: sqlite | mysql | postgres
  - `database.sqlite.file`: SQLite database file path
  - `database.mysql.*`: MySQL connection parameters (host, port, database, user, password, useSSL)
  - `database.postgres.*`: PostgreSQL connection parameters
- **Market Configuration Keys**:
  - `market.updateInterval`: Price update frequency in seconds (default: 5)
  - `market.startOpen`: Whether market starts open on plugin load
  - `market.defaultStocks`: Whether to seed default stock instruments

### 4. Realistic Stock Price Algorithm
- **Location**: `core.algorithms.StockPriceCalculator`
- **Features**:
  - Multi-factor price calculation considering 25+ real-world market factors
  - Technical analysis (moving averages, support/resistance)
  - Momentum and trend following
  - Random market noise and occasional major events
  - Mean reversion to prevent unrealistic prices
  - Sector-specific factor weighting

### 5. Comprehensive Market Factors
- **Location**: `core.enums.MarketFactor`
- **Categories**:
  - Economic Indicators (inflation, interest rates, GDP, unemployment)
  - Market Sentiment (investor confidence, fear/greed index, media sentiment)
  - Industry Specific (sector performance, commodity prices, regulations)
  - Global Events (geopolitical events, natural disasters, pandemics)
  - Technical Factors (trading volume, liquidity, algorithmic trading)
  - Company Specific (earnings, dividends, management changes)
  - Seasonal/Cyclical patterns
  - Random Events (market manipulation, flash crashes, social media buzz)

### 6. Stock Market Service
- **Location**: `core.services.StockMarketService`
- **Capabilities**:
  - Stock registration and management
  - Real-time price updates (every 5 seconds)
  - Market statistics and analytics
  - Sector-based analysis
  - Performance tracking (top/worst performers)
  - Market sentiment calculation
  - Event simulation

### 7. Item Seeding System  
- **Location**: `application.boot.ItemSeeder`
- **Features**:
  - Automatically seeds Minecraft items as tradeable instruments
  - Maps Bukkit Material types to instrument symbols
  - Handles mock materials for testing environments
  - Configurable seeding via `market.defaultStocks` config

### 8. Testing Infrastructure
- **Location**: `src/test/java/com/example/quickstocks/StockMarketSimulationTest.java`
- **Features**:
  - Comprehensive simulation with 10 diverse stocks
  - 5-second update intervals
  - Real-time market statistics display
  - Random market event simulation
  - Performance analytics

### 9. Command System (Planned)
- **Command Prefix**: `/stocks`
- **Planned Commands**:
  - `/stocks list` - Display available instruments/stocks
  - `/stocks price <symbol>` - Get current price for a specific instrument
  - `/stocks buy <symbol> <amount>` - Purchase shares of an instrument
  - `/stocks sell <symbol> <amount>` - Sell shares of an instrument  
  - `/stocks portfolio` - View player's current holdings
  - `/stocks market` - Display market overview and statistics
  - `/stocks history <symbol>` - Show price history for an instrument
  - `/stocks top` - Show best performing instruments
  - `/stocks worst` - Show worst performing instruments
- **Status**: Commands are planned but not yet implemented
- **Implementation Notes**: Command handlers should be added to plugin.yml and command executor classes

## Current Implementation Status

### ✅ Completed
- [x] Project structure and IoC architecture
- [x] Database layer and persistence system
- [x] Database migrations system (V1__init.sql)
- [x] Multi-database support (SQLite, MySQL, PostgreSQL)
- [x] Configuration system with config.yml
- [x] Core database tables (instruments, instrument_state, instrument_price_history)
- [x] Item seeding system for Minecraft materials
- [x] Comprehensive market factors enum (25+ factors)
- [x] Realistic stock price calculation algorithm
- [x] Stock and market influence models
- [x] Core stock market service
- [x] 5-second update simulation test
- [x] Plugin integration with Bukkit scheduler
- [x] .gitignore file (excludes .idea folder)
- [x] Updated copilot instructions with DB layer

### 🔄 In Progress
- [ ] Player interaction commands (/stocks command set)
- [ ] Command handlers and permission system
- [ ] Player portfolio management
- [ ] Trading mechanics integration with database

### 📋 Planned Features
- [ ] Complete command system implementation (/stocks commands)
- [ ] Player portfolios and trading mechanics
- [ ] Market visualization and GUI interfaces
- [ ] Economic events tied to Minecraft mechanics
- [ ] Web dashboard for market monitoring
- [ ] API endpoints for external integrations
- [ ] Player balance integration with economy plugins
- [ ] Market maker bots for liquidity
- [ ] Advanced analytics and reporting

## Key Design Principles

1. **Realism**: Stock prices behave similarly to real-world markets
2. **Transparency**: All market factors are visible and documented
3. **Scalability**: Architecture supports adding new features easily
4. **Testability**: Comprehensive test coverage with simulation capabilities
5. **Performance**: Efficient algorithms suitable for game server environment

## Development Guidelines

### 🚀 Essential Patterns for Copilot

**NEW FEATURES - Follow this pattern:**
1. **Service Layer**: Add business logic to `core/services/`
   ```java
   @Service // Use IoC pattern
   public class YourService {
       private final DatabaseManager dbManager;
       // Constructor injection
   }
   ```

2. **Database Changes**: Create migration files
   ```sql
   -- src/main/resources/migrations/V2__your_change.sql
   ALTER TABLE instruments ADD COLUMN your_field TEXT;
   ```

3. **Models**: Place in `core/models/` with proper validation
   ```java
   public class YourModel {
       // Use record classes when possible
       // Include validation methods
   }
   ```

**COMMANDS - Minecraft integration:**
```java
// Pattern for new commands
public class YourCommand implements CommandExecutor, TabCompleter {
    // Use Adventure Components for rich text
    // Inject services via constructor
    // Handle permissions properly
}
```

### 🔒 Code Standards & Anti-Patterns

**✅ DO:**
- Use constructor injection for dependencies
- Add comprehensive JavaDoc comments for public APIs
- Follow existing error handling patterns
- Maintain thread safety for concurrent operations
- Use `infrastructure.db` package for all persistence
- Create migrations for schema changes (V2__*.sql, etc.)

**❌ DON'T:**
- Access database directly - use service layer
- Skip migration files for schema changes
- Break IoC patterns with static dependencies
- Ignore thread safety in multi-player environment
- Modify existing working functionality unnecessarily

### When Working on This Project:
1. **Always update these instructions** when making significant changes
2. **Maintain the IoC architecture** - new features should follow the established patterns
3. **Use the database layer** - all persistence should go through the infrastructure.db package
4. **Follow migration patterns** - schema changes require new migration files (V2__*.sql, etc.)
5. **Document breaking changes** in the section below
6. **Test thoroughly** using the simulation test before deploying changes
7. **Consider performance impact** - this runs in a game server environment
8. **Preserve realism** - market behavior should remain realistic

### Code Standards:
- Use clear, descriptive variable and method names
- Add comprehensive JavaDoc comments for public APIs
- Follow existing error handling patterns
- Maintain thread safety for concurrent operations
- Use appropriate data structures for performance

### 🧪 Testing Strategy

**Quick Verification Commands:**
```bash
# Test core market simulation
mvn -f pom-test.xml test -Dtest=StockMarketSimulationTest

# Run all available tests
mvn -f pom-test.xml test
```

**Test Coverage Checklist:**
- ✅ Market behavior simulation (`StockMarketSimulationTest`)
- ✅ Service layer functionality (various test classes)
- ⚠️ Database migrations (tested via MigrationRunner in services)
- ⚠️ Configuration loading from config.yml (manual testing needed)
- ⚠️ Performance under load (manual testing needed)
- ⚠️ Thread safety in multi-player environments (manual testing needed)
- ⚠️ Performance under load (manual testing needed)
- ⚠️ Thread safety in multi-player environments (manual testing needed)

**Testing Patterns:**
- Use JUnit 5 for new tests
- Mock external dependencies (database, Minecraft APIs)
- Test both success and failure scenarios
- Include edge cases and boundary conditions

## Breaking Changes Log

### Version 1.1.0-SNAPSHOT (Database Layer Implementation)
- **Date**: 2024-12-XX  
- **Changes**: 
  - **BREAKING**: Added database layer and persistence system
  - **BREAKING**: Introduced migration system requiring V1__init.sql
  - **BREAKING**: Added configuration system with config.yml dependencies
  - **BREAKING**: New database tables: instruments, instrument_state, instrument_price_history
  - **BREAKING**: Item seeding system now populates database on startup
  - Database provider support: SQLite (default), MySQL, PostgreSQL
  - Connection pooling and transaction management
  - New infrastructure.db package with DB utilities
- **Migration Impact**: Existing deployments need database initialization
- **Config Impact**: New config.yml file required with database settings

### Version 1.0.0-SNAPSHOT (Initial Setup)
- **Date**: 2024-12-XX
- **Changes**: 
  - Initial project structure established
  - Core stock market simulation implemented
  - 25+ market factors defined and integrated
  - Realistic price calculation algorithm developed
  - Test infrastructure created

### Future Breaking Changes
*Add new breaking changes here when they occur, including:*
- *Date of change*
- *Description of what changed*
- *Impact on existing code*
- *Migration steps if needed*

## Architecture Decisions

### Why IoC Architecture?
- **Testability**: Easy to mock dependencies and create unit tests
- **Maintainability**: Clear separation of concerns
- **Extensibility**: New features can be added without modifying existing code
- **Flexibility**: Different implementations can be swapped easily

### Why These Market Factors?
Based on research of real-world stock market influences, covering:
- Economic fundamentals
- Psychological factors
- Technical indicators
- External events
- Company-specific news

### Why Database Layer Architecture?
- **Persistence**: Market data survives server restarts
- **Scalability**: Supports large numbers of instruments and historical data
- **Performance**: Indexed queries for fast market data retrieval
- **Analytics**: Historical data enables trend analysis and reporting
- **Multi-Server**: Database can be shared across server instances
- **Backup/Recovery**: Standard database backup procedures apply

### Why Generic Instrument Schema?
- **Flexibility**: Single schema supports stocks, crypto, items, indices
- **Extensibility**: Easy to add new instrument types
- **Consistency**: Uniform price tracking and history across all types
- **Minecraft Integration**: Items are first-class tradeable instruments
- **Future-Proof**: Supports complex financial instruments

### Why Migration System?
- **Version Control**: Schema changes are tracked and versioned
- **Safe Deployments**: Automatic schema updates prevent manual errors
- **Rollback Support**: Failed migrations are logged and can be recovered
- **Team Development**: Consistent database state across environments

## Notes for Future Development
- Consider adding seasonal events tied to Minecraft calendar
- Implement company earnings based on player activity
- Add sector rotation based on server events
- Consider integration with economy plugins (Vault API)
- Plan for multi-server market synchronization via shared database
- Add command permissions and player balance integration
- Implement portfolio persistence and trading history
- Consider real-time price feeds from external APIs for crypto/stocks

## 🔧 Troubleshooting Guide

### Common Build Issues
**Problem**: Maven can't resolve PaperMC dependencies
```bash
# Solution: Use test profile
mvn -f pom-test.xml clean compile
```

**Problem**: Compilation errors with Bukkit classes
```bash
# Solution: Plugin classes are in .ready files
./activate-plugin.sh  # Renames .ready to .java files
```

**Problem**: Tests fail with database errors
```bash
# Solution: Check database setup or try running market simulation test
mvn -f pom-test.xml test -Dtest=StockMarketSimulationTest
```

### Runtime Issues
**Database Connection Failures:**
- Check config.yml database settings
- Verify SQLite file permissions (plugins/QuickStocks/data.db)
- For MySQL/PostgreSQL: validate connection parameters

**Market Simulation Not Working:**
- Verify StockMarketService is properly initialized
- Check if market.updateInterval is set in config.yml
- Ensure database tables are created (run migrations)

**Command Registration Failures:**
- Verify plugin.yml contains command definitions
- Check that command classes extend proper Bukkit interfaces
- Ensure proper permissions are configured

### Performance Issues
- **High CPU**: Reduce market.updateInterval in config.yml
- **Memory leaks**: Check for unclosed database connections
- **Slow queries**: Add database indexes for frequently accessed data

### Getting Help
1. Check server logs for detailed error messages
2. Run `StockMarketSimulationTest` to verify core functionality
3. Review migration logs in database schema_version table
4. Validate configuration file syntax (config.yml)