# QuickStocks - Copilot Instructions

## Project Overview
QuickStocks is a Minecraft Paper plugin (version 1.21.8) that simulates a realistic stock market within the game. The plugin focuses on economical features and provides players with an immersive stock trading experience based on real-world market factors and behaviors.

## Architecture
The project follows an **Inversion of Control (IoC) architecture** with clear separation of concerns:

```
src/main/java/com/example/quickstocks/
â”œâ”€â”€ QuickStocksPlugin.java          # Main plugin class
â”œâ”€â”€ application/                    # Application layer
â”‚   â””â”€â”€ boot/                      # Bootstrap and seeding
â”‚       â”œâ”€â”€ ItemSeeder.java        # Seeds Minecraft items as instruments
â”‚       â”œâ”€â”€ MockMaterial.java      # Mock materials for testing
â”‚       â””â”€â”€ WordUtils.java         # String utilities
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ services/                   # Business logic services
â”‚   â”‚   â””â”€â”€ StockMarketService.java # Core market management
â”‚   â”œâ”€â”€ models/                     # Data models
â”‚   â”‚   â”œâ”€â”€ Stock.java             # Stock representation
â”‚   â”‚   â””â”€â”€ MarketInfluence.java   # Market factor influences
â”‚   â”œâ”€â”€ algorithms/                # Core algorithms
â”‚   â”‚   â””â”€â”€ StockPriceCalculator.java # Realistic price calculation
â”‚   â”œâ”€â”€ enums/                     # Enumerations
â”‚   â”‚   â””â”€â”€ MarketFactor.java      # Market influence factors
â”‚   â”œâ”€â”€ interfaces/                # Contracts (future)
â”‚   â””â”€â”€ events/                    # Event system (future)
â””â”€â”€ infrastructure/                # Infrastructure layer
    â””â”€â”€ db/                        # Database layer
        â”œâ”€â”€ ConfigLoader.java      # Configuration file loader
        â”œâ”€â”€ DatabaseConfig.java    # Database configuration holder
        â”œâ”€â”€ DatabaseManager.java   # Central DB coordinator
        â”œâ”€â”€ DataSourceProvider.java # Connection pooling
        â”œâ”€â”€ Db.java               # Database utility wrapper
        â””â”€â”€ MigrationRunner.java   # Schema migration management
```

## Core Features Implemented

### 1. Database Layer & Persistence System
- **Location**: `infrastructure.db` package
- **Components**:
  - **DatabaseManager**: Central coordinator for DB initialization, migrations, and connection management
  - **ConfigLoader**: Loads database configuration from `config.yml` or properties files
  - **DatabaseConfig**: Configuration holder supporting SQLite, MySQL, and PostgreSQL
  - **DataSourceProvider**: Connection pooling and database provider abstraction
  - **Db**: Database utility wrapper with simplified query/update operations
  - **MigrationRunner**: Schema migration management with versioning support
- **Migration System**: 
  - **Location**: `src/main/resources/migrations/`
  - **Current Version**: V1 (V1__init.sql)
  - **Features**: Automatic schema versioning, rollback tracking, migration status logging

### 2. Database Schema (v1)
- **instruments** table: Core instrument registry
  - Supports multiple types: ITEM, CRYPTO, EQUITY, INDEX, FUND, CUSTOM_CRYPTO
  - Generic schema for Minecraft items, cryptocurrencies, and traditional stocks
  - Fields: id (UUID), type, symbol, display_name, mc_material, decimals, created_by, created_at
- **instrument_state** table: Current market state for fast reads
  - Real-time price and volume data
  - Performance metrics: change_1h, change_24h, volatility_24h, market_cap
  - Updated via market simulation engine
- **instrument_price_history** table: Append-only historical data
  - Complete price/volume history for analytics
  - Tracks reasons for price movements (market factors)
  - Indexed by instrument and timestamp for efficient queries

### 3. Configuration System
- **Location**: `src/main/resources/config.yml`
- **Database Configuration Keys**:
  - `database.provider`: sqlite | mysql | postgres
  - `database.sqlite.file`: SQLite database file path
  - `database.mysql.*`: MySQL connection parameters (host, port, database, user, password, useSSL)
  - `database.postgres.*`: PostgreSQL connection parameters
- **Market Configuration Keys**:
  - `market.updateInterval`: Price update frequency in seconds (default: 5)
  - `market.startOpen`: Whether market starts open on plugin load
  - `market.defaultStocks`: Whether to seed default stock instruments

### 4. Realistic Stock Price Algorithm
- **Location**: `core.algorithms.StockPriceCalculator`
- **Features**:
  - Multi-factor price calculation considering 25+ real-world market factors
  - Technical analysis (moving averages, support/resistance)
  - Momentum and trend following
  - Random market noise and occasional major events
  - Mean reversion to prevent unrealistic prices
  - Sector-specific factor weighting

### 5. Comprehensive Market Factors
- **Location**: `core.enums.MarketFactor`
- **Categories**:
  - Economic Indicators (inflation, interest rates, GDP, unemployment)
  - Market Sentiment (investor confidence, fear/greed index, media sentiment)
  - Industry Specific (sector performance, commodity prices, regulations)
  - Global Events (geopolitical events, natural disasters, pandemics)
  - Technical Factors (trading volume, liquidity, algorithmic trading)
  - Company Specific (earnings, dividends, management changes)
  - Seasonal/Cyclical patterns
  - Random Events (market manipulation, flash crashes, social media buzz)

### 6. Stock Market Service
- **Location**: `core.services.StockMarketService`
- **Capabilities**:
  - Stock registration and management
  - Real-time price updates (every 5 seconds)
  - Market statistics and analytics
  - Sector-based analysis
  - Performance tracking (top/worst performers)
  - Market sentiment calculation
  - Event simulation

### 7. Item Seeding System  
- **Location**: `application.boot.ItemSeeder`
- **Features**:
  - Automatically seeds Minecraft items as tradeable instruments
  - Maps Bukkit Material types to instrument symbols
  - Handles mock materials for testing environments
  - Configurable seeding via `market.defaultStocks` config

### 8. Testing Infrastructure
- **Location**: `src/test/java/com/example/quickstocks/StockMarketSimulationTest.java`
- **Features**:
  - Comprehensive simulation with 10 diverse stocks
  - 5-second update intervals
  - Real-time market statistics display
  - Random market event simulation
  - Performance analytics

### 9. Command System (Planned)
- **Command Prefix**: `/stocks`
- **Planned Commands**:
  - `/stocks list` - Display available instruments/stocks
  - `/stocks price <symbol>` - Get current price for a specific instrument
  - `/stocks buy <symbol> <amount>` - Purchase shares of an instrument
  - `/stocks sell <symbol> <amount>` - Sell shares of an instrument  
  - `/stocks portfolio` - View player's current holdings
  - `/stocks market` - Display market overview and statistics
  - `/stocks history <symbol>` - Show price history for an instrument
  - `/stocks top` - Show best performing instruments
  - `/stocks worst` - Show worst performing instruments
- **Status**: Commands are planned but not yet implemented
- **Implementation Notes**: Command handlers should be added to plugin.yml and command executor classes

## Current Implementation Status

### âœ… Completed
- [x] Project structure and IoC architecture
- [x] Database layer and persistence system
- [x] Database migrations system (V1__init.sql)
- [x] Multi-database support (SQLite, MySQL, PostgreSQL)
- [x] Configuration system with config.yml
- [x] Core database tables (instruments, instrument_state, instrument_price_history)
- [x] Item seeding system for Minecraft materials
- [x] Comprehensive market factors enum (25+ factors)
- [x] Realistic stock price calculation algorithm
- [x] Stock and market influence models
- [x] Core stock market service
- [x] 5-second update simulation test
- [x] Plugin integration with Bukkit scheduler
- [x] .gitignore file (excludes .idea folder)
- [x] Updated copilot instructions with DB layer

### ðŸ”„ In Progress
- [ ] Player interaction commands (/stocks command set)
- [ ] Command handlers and permission system
- [ ] Player portfolio management
- [ ] Trading mechanics integration with database

### ðŸ“‹ Planned Features
- [ ] Complete command system implementation (/stocks commands)
- [ ] Player portfolios and trading mechanics
- [ ] Market visualization and GUI interfaces
- [ ] Economic events tied to Minecraft mechanics
- [ ] Web dashboard for market monitoring
- [ ] API endpoints for external integrations
- [ ] Player balance integration with economy plugins
- [ ] Market maker bots for liquidity
- [ ] Advanced analytics and reporting

## Key Design Principles

1. **Realism**: Stock prices behave similarly to real-world markets
2. **Transparency**: All market factors are visible and documented
3. **Scalability**: Architecture supports adding new features easily
4. **Testability**: Comprehensive test coverage with simulation capabilities
5. **Performance**: Efficient algorithms suitable for game server environment

## Development Guidelines

### When Working on This Project:
1. **Always update these instructions** when making significant changes
2. **Maintain the IoC architecture** - new features should follow the established patterns
3. **Use the database layer** - all persistence should go through the infrastructure.db package
4. **Follow migration patterns** - schema changes require new migration files (V2__*.sql, etc.)
5. **Document breaking changes** in the section below
6. **Test thoroughly** using the simulation test before deploying changes
7. **Consider performance impact** - this runs in a game server environment
8. **Preserve realism** - market behavior should remain realistic

### Code Standards:
- Use clear, descriptive variable and method names
- Add comprehensive JavaDoc comments for public APIs
- Follow existing error handling patterns
- Maintain thread safety for concurrent operations
- Use appropriate data structures for performance

### Testing:
- Run `StockMarketSimulationTest` to verify market behavior
- Run database migration tests in `SimpleMigrationTest`
- Test with various market conditions and events
- Validate database operations and connection pooling
- Test configuration loading from config.yml
- Validate performance under load
- Ensure thread safety in multi-player environments

## Breaking Changes Log

### Version 1.1.0-SNAPSHOT (Database Layer Implementation)
- **Date**: 2024-12-XX  
- **Changes**: 
  - **BREAKING**: Added database layer and persistence system
  - **BREAKING**: Introduced migration system requiring V1__init.sql
  - **BREAKING**: Added configuration system with config.yml dependencies
  - **BREAKING**: New database tables: instruments, instrument_state, instrument_price_history
  - **BREAKING**: Item seeding system now populates database on startup
  - Database provider support: SQLite (default), MySQL, PostgreSQL
  - Connection pooling and transaction management
  - New infrastructure.db package with DB utilities
- **Migration Impact**: Existing deployments need database initialization
- **Config Impact**: New config.yml file required with database settings

### Version 1.0.0-SNAPSHOT (Initial Setup)
- **Date**: 2024-12-XX
- **Changes**: 
  - Initial project structure established
  - Core stock market simulation implemented
  - 25+ market factors defined and integrated
  - Realistic price calculation algorithm developed
  - Test infrastructure created

### Future Breaking Changes
*Add new breaking changes here when they occur, including:*
- *Date of change*
- *Description of what changed*
- *Impact on existing code*
- *Migration steps if needed*

## Architecture Decisions

### Why IoC Architecture?
- **Testability**: Easy to mock dependencies and create unit tests
- **Maintainability**: Clear separation of concerns
- **Extensibility**: New features can be added without modifying existing code
- **Flexibility**: Different implementations can be swapped easily

### Why These Market Factors?
Based on research of real-world stock market influences, covering:
- Economic fundamentals
- Psychological factors
- Technical indicators
- External events
- Company-specific news

### Why Database Layer Architecture?
- **Persistence**: Market data survives server restarts
- **Scalability**: Supports large numbers of instruments and historical data
- **Performance**: Indexed queries for fast market data retrieval
- **Analytics**: Historical data enables trend analysis and reporting
- **Multi-Server**: Database can be shared across server instances
- **Backup/Recovery**: Standard database backup procedures apply

### Why Generic Instrument Schema?
- **Flexibility**: Single schema supports stocks, crypto, items, indices
- **Extensibility**: Easy to add new instrument types
- **Consistency**: Uniform price tracking and history across all types
- **Minecraft Integration**: Items are first-class tradeable instruments
- **Future-Proof**: Supports complex financial instruments

### Why Migration System?
- **Version Control**: Schema changes are tracked and versioned
- **Safe Deployments**: Automatic schema updates prevent manual errors
- **Rollback Support**: Failed migrations are logged and can be recovered
- **Team Development**: Consistent database state across environments

## Notes for Future Development
- Consider adding seasonal events tied to Minecraft calendar
- Implement company earnings based on player activity
- Add sector rotation based on server events
- Consider integration with economy plugins (Vault API)
- Plan for multi-server market synchronization via shared database
- Add command permissions and player balance integration
- Implement portfolio persistence and trading history
- Consider real-time price feeds from external APIs for crypto/stocks